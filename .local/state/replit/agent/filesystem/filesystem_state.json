{"file_contents":{"main.py":{"content":"# main.py → FINAL AUTOMATION FOR BODHIH.COM (LIVE & PERFECT)\n# Razorpay Payment → Extract Type from Product → Register on DISC Asia+ → Send Email\n\nfrom flask import Flask, request\nimport requests\nfrom datetime import datetime\nimport logging\nimport os\nimport smtplib\nfrom email.message import EmailMessage\nimport secrets\nimport string\nimport json\nimport re\nimport sys\n\napp = Flask(__name__)\nlogging.basicConfig(stream=sys.stdout, level=logging.INFO)\n\n# UPDATE THESE 6 LINES ONLY\nDISC_API_URL       = \"https://discapi.discasiaplus.org/api/DISC/Respondent_and_Report_Details_Bodhih\"\nDISC_CREDENTIAL    = \"vezHgzd1EueI3clvF/1kNnMyCITD9UwC\"\n\nSMTP_EMAIL         = \"info@inowix.in\"          # ← Your Gmail\nSMTP_PASSWORD      = \"Inowix2025@\"      # ← Gmail App Password\nFROM_NAME          = \"Bodhi Training Solutions\"\nREPLY_TO_EMAIL     = \"support@bodhih.com\"\n\ndef generate_password():\n    return ''.join(secrets.choice(string.ascii_letters + string.digits + \"!@#$%^&*\") for _ in range(12))\n\ndef extract_report_type(description):\n    \"\"\"Extract type from product name like 'Self-Awareness Advanced Report' → 'Self-Awareness Advanced'\"\"\"\n    if not description:\n        return \"Basic\"\n    \n    # Remove common words\n    text = description.replace(\"DISC\", \"\").replace(\"Report\", \"\").replace(\"report\", \"\")\n    # Get everything before \"Report\"\n    match = re.search(r\"(.+?)(?:\\s+Report|$)\", description, re.IGNORECASE)\n    if match:\n        cleaned = match.group(1).strip()\n        return cleaned if cleaned else \"Basic\"\n    return \"Basic\"\n\ndef register_on_disc_asia(name, display_name, email, gender, report_type):\n    payload = {\n        \"credentials\": {\"encryptedPassword\": DISC_CREDENTIAL},\n        \"respondentDetails\": [{\n            \"name\": name,\n            \"displayName\": display_name,\n            \"gender\": gender.title(),\n            \"eMailAddress\": email,\n            \"type\": report_type\n        }],\n        \"transactionDetails\": {\n            \"transactionId\": 0,\n            \"transactionDate\": datetime.now().isoformat(),\n            \"isSuccessful\": True\n        }\n    }\n\n    try:\n        r = requests.post(DISC_API_URL, json=payload, timeout=20)\n        result = r.json()\n        if result.get(\"success\") and result.get(\"respondentDetails\"):\n            link = result[\"respondentDetails\"][0].get(\"link\")\n            logging.info(f\"DISC SUCCESS → {report_type} | Link: {link}\")\n            return link\n        else:\n            logging.info(f\"DISC FAILED → {result.get('errorMessage')}\")\n            return None\n    except Exception as e:\n        logging.info(f\"DISC EXCEPTION → {e}\")\n        return None\n\ndef send_email(name, email, amount, payment_id, report_type, disc_link, password):\n    msg = EmailMessage()\n    msg['From'] = f\"{FROM_NAME} <{SMTP_EMAIL}>\"\n    msg['To'] = email\n    msg['Reply-To'] = REPLY_TO_EMAIL\n    msg['Subject'] = f\"Your {report_type} DISC Report is Ready!\"\n\n    html = f\"\"\"\n    <html>\n    <body style=\"font-family:Arial,sans-serif;max-width:600px;margin:30px auto;padding:20px;background:#f9f9f9;border-radius:10px;\">\n        <h2 style=\"color:#2c3e50;text-align:center;\">Payment Confirmed!</h2>\n        <p>Dear <strong>{name}</strong>,</p>\n        <p>Thank you for purchasing:</p>\n        <h3 style=\"background:#e3f2fd;padding:15px;border-radius:8px;text-align:center;\">\n            {report_type} Report\n        </h3>\n        <p><strong>Amount Paid:</strong> ₹{amount:,.2f}<br>\n           <strong>Payment ID:</strong> {payment_id}</p>\n\n        <h3>Your DISC Assessment Access</h3>\n        <p><strong>Login Email:</strong> {email}<br>\n           <strong>Password:</strong> <code style=\"background:#eee;padding:8px;font-size:15px;\">{password}</code></p>\n\n        <div style=\"text-align:center;margin:30px 0;\">\n            <a href=\"{disc_link}\" style=\"background:#1976d2;color:white;padding:16px 32px;text-decoration:none;border-radius:8px;font-size:18px;\">\n                Start Your Assessment Now\n            </a>\n        </div>\n\n        <p style=\"background:#fff3cd;padding:15px;border-radius:8px;\">\n            This link is unique to you. Keep this email safe.\n        </p>\n\n        <p style=\"font-size:12px;color:#777;text-align:center;\">\n            Need help? Reply to this email.<br>\n            Bodhi Training Solutions | www.bodhih.com\n        </p>\n    </body>\n    </html>\n    \"\"\"\n    msg.set_content(\"HTML email required.\")\n    msg.add_alternative(html, subtype='html')\n\n    try:\n        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as s:\n            s.login(SMTP_EMAIL, SMTP_PASSWORD)\n            s.send_message(msg)\n        logging.info(f\"EMAIL SENT → {email}\")\n    except Exception as e:\n        logging.info(f\"EMAIL FAILED → {e}\")\n\n@app.route('/razorpay-webhook', methods=['POST'])\ndef webhook():\n    data = request.get_json(force=True) or {}\n    if not data or data.get('event') != 'payment.captured':\n        return \"ok\", 200\n\n    p = data['payload']['payment']['entity']\n    notes = p.get('notes', {})\n\n    # Extract data\n    name         = notes.get('name', p.get('customer_name', 'Customer'))\n    display_name = name  # Same as name\n    email        = p.get('email') or notes.get('user_email', 'no-email@bodhih.com')\n    gender       = notes.get('gender', 'Male')\n    description  = p.get('description', '')\n    amount       = p['amount'] / 100\n\n    # Extract report type from product name\n    report_type = extract_report_type(description)\n\n    logging.info(\"\\n\" + \"═\" * 95)\n    logging.info(\"FULL AUTOMATION LIVE — BODHIH.COM\")\n    logging.info(\"═\" * 95)\n    logging.info(f\"Time         : {datetime.now().strftime('%d %b %Y, %I:%M %p')}\")\n    logging.info(f\"Name         : {name}\")\n    logging.info(f\"Email        : {email}\")\n    logging.info(f\"Product      : {description}\")\n    logging.info(f\"Report Type  : {report_type}\")\n    logging.info(f\"Amount       : ₹{amount:,.2f}\")\n    logging.info(f\"Payment ID   : {p['id']}\")\n\n    # Register on DISC Asia+\n    disc_link = register_on_disc_asia(name, display_name, email, gender, report_type)\n\n    if disc_link:\n        password = generate_password()\n        send_email(name, email, amount, p['id'], report_type, disc_link, password)\n        logging.info(\"SUCCESS: DISC Account Created + Email Sent\")\n    else:\n        logging.info(\"DISC REGISTRATION FAILED — No email sent\")\n\n    logging.info(\"═\" * 95 + \"\\n\")\n    return \"OK\", 200\n\nif __name__ == \"__main__\":\n    app.run(host=\"0.0.0.0\", port=int(os.environ.get(\"PORT\", 5000)))","size_bytes":6459}},"version":2}